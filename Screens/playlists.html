<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="Styles/PlaylistStyle.css">
  <link rel="icon" type="image/png" href="Images+Videos/Website_Logo.png">
  <style>

  </style>
</head>

<body>

  <script src="LightDarkMode.js"></script>


  <header>
    <div id="logo">PodsForSquads</div>
    <nav>
      <a id="Home" href="HomeScreen.html">Home</a>
      <a id="Upload" href="Upload.html">Upload</a>
      <a id="Playlists" href="Playlists.html">Playlists</a>
      <a id="Favorites" href="Favorites.html">Favorites</a>
      <a id="Community" href="Community.html">Community</a>
      <a id="Analytics" href="Analytics.html">Stats</a>
      <a id="Settings" href="Settings.html">Settings</a>
    </nav>

    <div class="profile-dropdown">
      <div class="profile-icon">
        <img id="profileImage" src="./Images+Videos/DefaultProfile.png" alt="User Profile">
        <i class="arrow down"></i>
      </div>

      <div class="dropdown-content">
        <a href="Settings.html">View Profile</a>
        <a href="Auth/Login.html">Log Out</a>
      </div>
    </div>
  </header>

  <div class="main-content">

    <div class="playlists-container" id="playlists-container"></div>


    <div id="create-playlist-modal" class="modal">
      <div class="modal-content">
        <span class="close">&times;</span>
        <h2>Create New Playlist</h2>
        <div class="form-group">
          <input type="text" id="playlist-name" placeholder="Enter playlist name">
        </div>
        <div class="form-group">
          <label for="playlist-color">Choose playlist color:</label>
          <input type="color" id="playlist-color" value="#FF9494">
        </div>
        <div class="form-group">
          <input type="text" id="search-input" placeholder="Search for podcasts...">
        </div>
        <div id="search-results"></div>
        <button id="create-playlist">Create Playlist</button>
      </div>
    </div>


    <div id="view-playlist-modal" class="modal">
      <div class="modal-content">
        <span class="close">&times;</span>
        <h2 id="playlist-title"></h2>
        <button id="delete-all-podcasts">Delete All Podcasts</button>
        <div id="playlist-podcasts"></div>
      </div>
    </div>


    <div id="podcast-details-modal" class="modal">
      <div class="modal-content">
        <span class="close">&times;</span>
        <div id="podcast-details-content"></div>
      </div>
    </div>
  </div>

  <footer>
    <div class="footer-links">
      <div class="footer-links">
        <a href="About_Us.html">About Us</a>
        <a href="Contact.html">Contact</a>
        <a href="ToS.html">Terms of Service</a>
        <a href="PrivPol.html">Privacy Policy</a>
        <a href="faq.html">FAQ</a>
      </div>
    </div>
    <div class="social-media">
      <a href="https://www.facebook.com/profile.php?id=61560365679571" target="_blank"><img
          src="Images+Videos/FB Icon.jpg" alt="Facebook"></a>
      <a href="https://x.com/PodsForSquads" target="_blank"><img src="Images+Videos/Twitter_Logo.png" alt="Twitter"></a>
      <a href="https://www.instagram.com/podsforsquads/" target="_blank"><img src="Images+Videos/IG Icon.jpg"
          alt="Instagram"></a>
    </div>
  </footer>

  <script>

    const API_KEY = 'cb2038d4dbd841b39dec5309c31b2d6a';
    const BASE_URL = 'https://listen-api.listennotes.com/api/v2';


    const playlistsContainer = document.getElementById('playlists-container');
    const createPlaylistModal = document.getElementById('create-playlist-modal');
    const viewPlaylistModal = document.getElementById('view-playlist-modal');
    const podcastDetailsModal = document.getElementById('podcast-details-modal');
    const closeButtons = document.querySelectorAll('.close');
    const searchInput = document.getElementById('search-input');
    const searchResults = document.getElementById('search-results');
    const createPlaylistButton = document.getElementById('create-playlist');
    const playlistNameInput = document.getElementById('playlist-name');
    const playlistColorInput = document.getElementById('playlist-color');
    const playlistTitle = document.getElementById('playlist-title');
    const playlistPodcasts = document.getElementById('playlist-podcasts');
    const podcastDetailsContent = document.getElementById('podcast-details-content');
    const deleteAllPodcastsButton = document.getElementById('delete-all-podcasts');

    let selectedPodcasts = [];
    let playlists = JSON.parse(localStorage.getItem('playlists')) || [];


    closeButtons.forEach(button => {
      button.addEventListener('click', () => {
        button.closest('.modal').style.display = 'none';
      });
    });


    searchInput.addEventListener('input', debounce(handleSearch, 300));

    async function handleSearch() {
      const query = searchInput.value.trim();
      if (query) {
        try {
          const response = await fetch(`${BASE_URL}/search?q=${query}&type=podcast`, {
            headers: {
              'X-ListenAPI-Key': API_KEY
            }
          });
          if (!response.ok) throw new Error('Search failed');
          const data = await response.json();
          displaySearchResults(data.results);
        } catch (error) {
          console.error('Error searching podcasts:', error);
          searchResults.innerHTML = '<p>An error occurred while searching. Please try again.</p>';
        }
      } else {
        searchResults.innerHTML = '';
      }
    }

    function displaySearchResults(results) {
      searchResults.innerHTML = '';
      results.forEach(podcast => {
        const podcastItem = document.createElement('div');
        podcastItem.classList.add('podcast-option');
        podcastItem.innerHTML = `
          <input type="checkbox" id="${podcast.id}" value="${podcast.id}">
          <label for="${podcast.id}">
            <img src="${podcast.thumbnail}" alt="${podcast.title_original}" style="width: 50px; height: 50px; margin-right: 10px;">
            ${podcast.title_original}
          </label>
        `;
        searchResults.appendChild(podcastItem);
      });

      document.querySelectorAll('.podcast-option input[type="checkbox"]').forEach(checkbox => {
        checkbox.addEventListener('change', (event) => {
          const podcastId = event.target.value;
          if (event.target.checked) {
            if (!selectedPodcasts.includes(podcastId)) {
              selectedPodcasts.push(podcastId);
            }
          } else {
            selectedPodcasts = selectedPodcasts.filter(id => id !== podcastId);
          }
        });
      });
    }

    createPlaylistButton.addEventListener('click', async () => {
      const playlistName = playlistNameInput.value.trim();
      const playlistColor = playlistColorInput.value;


      if (playlistName === '') {
        alert('Please enter a playlist name.');
        return;
      }

      if (selectedPodcasts.length === 0) {
        alert('Please select at least one podcast.');
        return;
      }
      const podcastDetails = await Promise.all(selectedPodcasts.map(async (podcastId) => {
        try {
          const response = await fetch(`${BASE_URL}/podcasts/${podcastId}`, {
            headers: {
              'X-ListenAPI-Key': API_KEY
            }
          });
          const data = await response.json();
          return {
            id: data.id,
            title: data.title,
            thumbnail: data.thumbnail,
            publisher: data.publisher
          };
        } catch (error) {
          console.error('Error fetching podcast details:', error);
          return null;
        }
      }));
      const validPodcasts = podcastDetails.filter(podcast => podcast !== null);
      const newPlaylist = {
        id: Date.now(),
        name: playlistName,
        color: playlistColor,
        podcasts: validPodcasts,
        coverImage: validPodcasts[0]?.thumbnail || 'default-playlist-image.jpg'
      };
      playlists.push(newPlaylist);
      localStorage.setItem('playlists', JSON.stringify(playlists));
      displayPlaylists();
      createPlaylistModal.style.display = 'none';
      searchResults.innerHTML = '';
      selectedPodcasts = [];
      playlistNameInput.value = '';
      playlistColorInput.value = '#FF9494';
    });


    function displayPlaylists() {
      playlistsContainer.innerHTML = '';
      const createPlaylistBox = document.createElement('div');
      createPlaylistBox.id = 'create-playlist-button';
      createPlaylistBox.classList.add('new-playlist-box');
      createPlaylistBox.textContent = 'Create New Playlist';
      createPlaylistBox.addEventListener('click', () => {
        createPlaylistModal.style.display = 'block';
      });
      playlistsContainer.appendChild(createPlaylistBox);

      for (const playlist of playlists) {
        const playlistItem = document.createElement('div');
        playlistItem.classList.add('playlist-item');
        playlistItem.style.backgroundColor = playlist.color;

        let thumbnailSrc = 'default-playlist-image.jpg';
        let podcastCount = playlist.podcasts.length;

        if (playlist.podcasts.length > 0) {
          thumbnailSrc = playlist.podcasts[0].thumbnail || playlist.coverImage;
        }

        playlistItem.innerHTML = `
      <img src="${thumbnailSrc}" alt="${playlist.name}">
      <h3>${playlist.name}</h3>
      <p>${podcastCount} podcast${podcastCount !== 1 ? 's' : ''}</p>
      <button class="delete-playlist" onclick="deletePlaylist(event, ${playlist.id})">Ã—</button>
    `;

        playlistItem.addEventListener('click', () => viewPlaylist(playlist.id));
        playlistsContainer.appendChild(playlistItem);
      }
    }

    async function viewPlaylist(playlistId) {
      const playlist = playlists.find(p => p.id === playlistId);
      if (playlist) {
        playlistTitle.textContent = playlist.name;
        playlistPodcasts.innerHTML = '';

        deleteAllPodcastsButton.onclick = () => deleteAllPodcasts(playlistId);

        for (const podcast of playlist.podcasts) {
          const podcastElement = document.createElement('div');
          podcastElement.classList.add('podcast-item');
          podcastElement.innerHTML = `
        <img src="${podcast.thumbnail}" alt="${podcast.title}" style="width: 50px; height: 50px;">
        <span>${podcast.title}</span>
        <button onclick="removePodcastFromPlaylist(${playlistId}, '${podcast.id}')">Remove</button>
      `;
          podcastElement.addEventListener('click', (e) => {
            if (e.target.tagName !== 'BUTTON') {
              viewPodcastDetails(podcast.id);
            }
          });
          playlistPodcasts.appendChild(podcastElement);
        }

        viewPlaylistModal.style.display = 'block';
      }
    }








    function toggleFavorite(element, podcastId, title, thumbnail, publisher) {
      element.classList.toggle('filled');
      const favorites = JSON.parse(localStorage.getItem('favorites')) || [];
      const isFavorite = favorites.some(fav => fav.id === podcastId);

      if (isFavorite) {
        const updatedFavorites = favorites.filter(fav => fav.id !== podcastId);
        localStorage.setItem('favorites', JSON.stringify(updatedFavorites));
      } else {
        const newFavorite = { id: podcastId, title: title, thumbnail: thumbnail, publisher: publisher };
        favorites.push(newFavorite);
        localStorage.setItem('favorites', JSON.stringify(favorites));
      }
    }

    function deletePlaylist(event, playlistId) {
      event.stopPropagation();
      if (confirm('Are you sure you want to delete this playlist?')) {
        playlists = playlists.filter(playlist => playlist.id !== playlistId);
        localStorage.setItem('playlists', JSON.stringify(playlists));
        displayPlaylists();
      }
    }

    function removePodcastFromPlaylist(playlistId, podcastId) {
      if (confirm('Are you sure you want to remove this podcast from the playlist?')) {
        const playlist = playlists.find(p => p.id === playlistId);
        if (playlist) {
          playlist.podcasts = playlist.podcasts.filter(podcast => podcast.id !== podcastId);
          localStorage.setItem('playlists', JSON.stringify(playlists));
          viewPlaylist(playlistId);  // Refresh view
          displayPlaylists();
        }
      }
    }
    function deleteAllPodcasts(playlistId) {
      if (confirm('Are you sure you want to delete all podcasts from this playlist?')) {
        const playlist = playlists.find(p => p.id === playlistId);
        if (playlist) {
          playlist.podcasts = [];
          playlist.coverImage = null;
          localStorage.setItem('playlists', JSON.stringify(playlists));
          viewPlaylist(playlistId);
          displayPlaylists();
        }
      }
    }
    async function viewPodcastDetails(podcastId) {
      try {
        let podcast;
        // First, check if the podcast is in any of our playlists
        for (const playlist of playlists) {
          podcast = playlist.podcasts.find(p => p.id === podcastId);
          if (podcast) break;
        }
        // If not found in playlists, fetch from API
        if (!podcast) {
          const response = await fetch(`${BASE_URL}/podcasts/${podcastId}`, {
            headers: {
              'X-ListenAPI-Key': API_KEY
            }

          });
          podcast = await response.json();
        }

        podcastDetailsContent.innerHTML = `
      <div class="modal-header">
        <h2>${podcast.title}</h2>
        <span class="heart-icon" onclick="toggleFavorite(this, '${podcast.id}', '${podcast.title}', '${podcast.thumbnail}', '${podcast.publisher}')">&#9825;</span>
      </div>
      <div class="podcast-details">
        <img src="${podcast.thumbnail}" alt="${podcast.title}" class="podcast-thumbnail">
        <a href="https://www.listennotes.com/c/${podcast.id}/embed/" target="_blank" class="play-button-image">
          <img src="play_button.png" alt="Play Podcast" class="play-button">
        </a>
      </div>
      <p><strong>Publisher:</strong> ${podcast.publisher}</p>
      <p><strong>Description:</strong> ${podcast.description || 'No description available.'}</p>
    `;
        podcastDetailsModal.style.display = 'block';
      } catch (error) {
        console.error('Error fetching podcast details:', error);
        alert('Error fetching podcast details. Please try again.');
      }
    }



    function toggleFavorite(element, podcastId, title, thumbnail, publisher) {

      console.log('Toggle favorite:', podcastId, title);
    }

    function addToPlaylist(podcastId, title, thumbnail, publisher) {

      console.log('Add to playlist:', podcastId, title);
    }

    function debounce(func, delay) {
      let timeoutId;
      return function (...args) {
        clearTimeout(timeoutId);
        timeoutId = setTimeout(() => func.apply(this, args), delay);
      };
    }


    document.addEventListener('DOMContentLoaded', displayPlaylists);


    window.onclick = function (event) {
      if (event.target.classList.contains('modal')) {
        event.target.style.display = 'none';
      }
    }
  </script>
</body>

</html>